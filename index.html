<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IoT - Cuaca, Sholat & AI Chat</title>
    
    <!-- Memuat Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Tone.js untuk efek suara -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- Konfigurasi Kustom untuk Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Mengaktifkan mode gelap berdasarkan class di <html>
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulse: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '.5' },
                        },
                         skeletonLoading: {
                            '0%': { backgroundColor: 'hsl(200, 20%, 80%)' },
                            '100%': { backgroundColor: 'hsl(200, 20%, 95%)' },
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'skeleton': 'skeletonLoading 1s linear infinite alternate'
                    }
                },
            }
        }
    </script>
    
    <!-- Memuat Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Transisi halus */
        body, .card, .modal-content {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        /* Styling Modal */
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        /* Styling Waktu Sholat */
        .prayer-time.next {
            background-color: #1d4ed8; /* bg-blue-700 */
            color: white;
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(30, 64, 175, 0.3), 0 4px 6px -2px rgba(30, 64, 175, 0.1);
        }
        .prayer-time.next h3, .prayer-time.next p, .prayer-time.next svg {
             color: white;
        }
        /* Custom scrollbar untuk chat */
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-track { background: #f1f5f9; } /* slate-100 */
        .dark #chat-messages::-webkit-scrollbar-track { background: #334155; } /* slate-700 */
        #chat-messages::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; } /* slate-400 */
        #chat-messages::-webkit-scrollbar-thumb:hover { background: #64748b; } /* slate-500 */
        
        /* Styling Skeleton Loader */
        .skeleton {
            animation: skeleton-loading 1s linear infinite alternate;
        }
        .dark .skeleton {
             animation: skeleton-loading-dark 1s linear infinite alternate;
        }
        @keyframes skeleton-loading-dark {
             0% { background-color: hsl(215, 28%, 17%); }
             100% { background-color: hsl(215, 20%, 30%); }
        }
        .data-content.loading { display: none; }
        .skeleton-container.loading .skeleton { display: block; }
        .skeleton-container .skeleton { display: none; }
        .task-item.completed span { text-decoration: line-through; color: #64748b; }
        .dark .task-item.completed span { color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 font-sans text-slate-800 dark:text-slate-200">

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Bagian Header -->
        <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white">Dashboard IoT</h1>
                <p id="location-display" class="text-sm text-slate-500 dark:text-slate-400">Memuat lokasi...</p>
            </div>
            <div class="flex items-center gap-2">
                 <button id="change-location-btn" class="clickable px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-slate-900">
                    Ubah Kota
                </button>
                <button id="theme-toggle" class="clickable p-2 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:focus:ring-offset-slate-900">
                    <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
        </header>

        <!-- Kontainer utama dengan layout vertikal -->
        <main class="grid grid-cols-1 gap-6 lg:gap-8">
            
            <!-- Kartu Jam -->
            <div class="card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col justify-center items-center border border-transparent dark:border-slate-700">
                 <div id="clock" class="text-4xl md:text-6xl font-bold text-slate-800 dark:text-white tracking-widest">00:00:00</div>
                 <div id="date" class="text-lg text-slate-500 dark:text-slate-400 mt-2"></div>
            </div>

            <!-- Grid untuk kartu cuaca (2x2 di mobile, 4x1 di desktop) -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 lg:gap-8">
                <!-- Kartu Suhu -->
                <div class="card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-transparent dark:border-slate-700 skeleton-container">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-200">Suhu</h2>
                        <div class="p-2 bg-red-100 dark:bg-red-900/50 rounded-lg"><svg class="w-6 h-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    </div>
                    <div class="data-content"><div id="temperature-value" class="text-4xl font-bold text-slate-900 dark:text-white">-- Â°C</div><div id="temperature-status" class="text-sm text-slate-500 dark:text-slate-400 mt-2"></div></div>
                    <div class="skeleton h-12 w-3/4 rounded-md"></div>
                </div>

                <!-- Kartu Kelembapan -->
                <div class="card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-transparent dark:border-slate-700 skeleton-container">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-200">Kelembapan</h2>
                        <div class="p-2 bg-sky-100 dark:bg-sky-900/50 rounded-lg"><svg class="w-6 h-6 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3zm0 0c-3.314 0-6 2.686-6 6s2.686 6 6 6 6-2.686 6-6-2.686-6-6-6zM4 12c0 4.418 3.582 8 8 8s8-3.582 8-8-3.582-8-8-8-8 3.582-8 8z"></path></svg></div>
                    </div>
                    <div class="data-content"><div id="humidity-value" class="text-4xl font-bold text-slate-900 dark:text-white">-- %</div><div id="humidity-status" class="text-sm text-slate-500 dark:text-slate-400 mt-2"></div></div>
                    <div class="skeleton h-12 w-3/4 rounded-md"></div>
                </div>
                
                <!-- Kartu Tekanan -->
                <div class="card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-transparent dark:border-slate-700 skeleton-container">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-200">Tekanan</h2>
                        <div class="p-2 bg-green-100 dark:bg-green-900/50 rounded-lg"><svg class="w-6 h-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></div>
                    </div>
                    <div class="data-content"><div id="pressure-value" class="text-4xl font-bold text-slate-900 dark:text-white">-- <span class="text-xl">hPa</span></div><div id="pressure-status" class="text-sm text-slate-500 dark:text-slate-400 mt-2"></div></div>
                    <div class="skeleton h-12 w-3/4 rounded-md"></div>
                </div>

                <!-- Kartu Cuaca -->
                <div class="card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-transparent dark:border-slate-700 skeleton-container">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-slate-700 dark:text-slate-200">Cuaca</h2>
                        <div class="p-2 bg-yellow-100 dark:bg-yellow-900/50 rounded-lg w-10 h-10"><div id="weather-icon-container" class="w-full h-full"></div></div>
                    </div>
                    <div class="data-content"><div id="weather-value" class="text-2xl font-bold text-slate-900 dark:text-white">--</div><div id="weather-status" class="text-sm text-slate-500 dark:text-slate-400 mt-2"></div></div>
                    <div class="skeleton h-12 w-3/4 rounded-md"></div>
                </div>
            </div>

            <!-- Bagian Waktu Sholat -->
             <div class="mt-4">
                <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Jadwal Sholat Hari Ini</h2>
                <div id="prayer-times-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- Skeleton untuk Waktu Sholat -->
                    <script>
                        for(let i=0; i<5; i++) {
                            document.write(`<div class="card bg-white dark:bg-slate-800 p-4 rounded-lg shadow flex flex-col items-center justify-center border border-transparent dark:border-slate-700 prayer-skeleton">
                                <div class="skeleton h-5 w-20 mb-2 rounded-md"></div><div class="skeleton h-8 w-24 rounded-md"></div></div>`);
                        }
                    </script>
                </div>
            </div>
            
            <!-- Bagian To-Do List -->
            <div class="card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg border border-transparent dark:border-slate-700">
                <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Daftar Tugas</h2>
                <form id="todo-form" class="flex gap-2 mb-4">
                    <input type="text" id="todo-input" class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Tambah tugas baru..." required>
                    <button type="submit" class="clickable px-4 py-2 font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Tambah</button>
                </form>
                <ul id="todo-list" class="space-y-2 h-48 overflow-y-auto pr-2">
                    <!-- Daftar tugas akan muncul di sini -->
                </ul>
            </div>
        </main>
    </div>

    <!-- Modal Ubah Lokasi -->
    <div id="location-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white dark:bg-slate-800 w-full max-w-md p-6 rounded-lg shadow-xl transform -translate-y-10">
            <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Ubah Lokasi</h2>
            <form id="location-form">
                <div class="mb-4">
                    <label for="city-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Pilih Kota</label>
                    <select id="city-select" name="city-select" class="w-full px-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="close-modal-btn" class="clickable px-4 py-2 text-sm font-medium bg-slate-200 dark:bg-slate-600 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500">Batal</button>
                    <button type="submit" class="clickable px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Tombol Floating AI Chat -->
    <button id="ai-chat-fab" class="clickable fixed bottom-6 right-6 bg-indigo-600 hover:bg-indigo-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center z-40">
        <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M14.213 19.336a3.743 3.743 0 01-4.426 0 3.744 3.744 0 01-1.3-2.837c0-1.74 1.185-3.23 2.822-3.666a.75.75 0 01.868.428.75.75 0 01-.428.868 2.24 2.24 0 00-1.706 2.37c0 .877.56 1.637 1.369 1.956a2.24 2.24 0 002.656 0c.81-.32 1.369-1.08 1.369-1.956a2.24 2.24 0 00-1.706-2.37.75.75 0 01.44-1.296c1.637.435 2.822 1.926 2.822 3.666 0 1.053-.42 2.01-1.12 2.69a3.733 3.733 0 01-1.583.791zm5.228-5.33a.75.75 0 01.559 1.325l-1.93 1.114a.75.75 0 01-1.118-.938l1.93-2.206a.75.75 0 01.56-.295zM4.559 14.006a.75.75 0 01.56.295l1.93 2.206a.75.75 0 11-1.118.938l-1.93-1.114a.75.75 0 01.559-1.325zM12 2.25a.75.75 0 01.75.75v3a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM6.438 4.938a.75.75 0 011.06 0l2.122 2.121a.75.75 0 11-1.06 1.06L6.438 6a.75.75 0 010-1.06zM20.121 6a.75.75 0 010 1.06l-2.121 2.122a.75.75 0 11-1.06-1.06l2.121-2.121a.75.75 0 011.06 0z"/></svg>
    </button>
    
    <!-- Modal AI Chat -->
    <div id="ai-chat-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-end sm:items-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white dark:bg-slate-800 w-full max-w-2xl h-[80vh] flex flex-col rounded-t-lg sm:rounded-lg shadow-xl transform translate-y-full sm:translate-y-10">
            <header class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800 dark:text-white">Tanya AI Gemini</h2>
                <button id="close-chat-btn" class="clickable text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl leading-none">&times;</button>
            </header>
            <main id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
                <div class="flex justify-start"><div class="bg-slate-200 dark:bg-slate-700 rounded-lg p-3 max-w-lg">Halo! Ada yang bisa saya bantu? Tanyakan apa saja.</div></div>
            </main>
            <footer class="p-4 border-t border-slate-200 dark:border-slate-700">
                <form id="chat-form" class="flex gap-2">
                    <input type="text" id="chat-input" class="w-full px-3 py-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Ketik pertanyaan Anda..." required>
                    <button type="submit" class="clickable px-4 py-2 font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M3.105 3.105a1.5 1.5 0 011.78-.17l12 6a1.5 1.5 0 010 2.74l-12 6A1.5 1.5 0 013 16.5V3.5a1.5 1.5 0 01.105-.445zM5 6.45v7.1L13.2 10 5 6.45z"></path></svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentLatitude, currentLongitude;
            let chatHistory = [];
            let todos = [];
            
            // --- FUNGSI EFEK SUARA ---
            const synth = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.2 }
            }).toDestination();
            
            function playClickSound() {
                synth.triggerAttackRelease("C5", "8n");
            }

            // --- DAFTAR KOTA UNTUK DROPDOWN ---
            const cities = [
                { name: "Bandung, Indonesia", lat: -6.9175, lon: 107.6191 },
                { name: "Jakarta, Indonesia", lat: -6.2146, lon: 106.8451 },
                { name: "Surabaya, Indonesia", lat: -7.2575, lon: 112.7521 },
                { name: "Medan, Indonesia", lat: 3.5952, lon: 98.6722 },
                { name: "Makassar, Indonesia", lat: -5.1477, lon: 119.4327 },
                { name: "Makkah, Saudi Arabia", lat: 21.4225, lon: 39.8262 },
                { name: "Madinah, Saudi Arabia", lat: 24.4686, lon: 39.6142 },
                { name: "Kuala Lumpur, Malaysia", lat: 3.1390, lon: 101.6869 },
                { name: "Singapura", lat: 1.3521, lon: 103.8198 },
                { name: "Tokyo, Jepang", lat: 35.6895, lon: 139.6917 },
            ];

            // --- ELEMEN DOM ---
            const locationDisplay = document.getElementById('location-display');
            const prayerContainer = document.getElementById('prayer-times-container');
            const clockEl = document.getElementById('clock');
            const dateEl = document.getElementById('date');
            const todoForm = document.getElementById('todo-form');
            const todoInput = document.getElementById('todo-input');
            const todoListEl = document.getElementById('todo-list');

            // --- FUNGSI JAM & TANGGAL ---
            function updateClock() {
                const now = new Date();
                clockEl.textContent = now.toLocaleTimeString('en-GB');
                dateEl.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            setInterval(updateClock, 1000);
            updateClock();
            
            // --- SKELETON LOADER ---
            function setSkeletonLoading(isLoading) {
                const containers = document.querySelectorAll('.skeleton-container');
                const prayerSkeletons = document.querySelectorAll('.prayer-skeleton');
                if(isLoading) {
                    containers.forEach(c => {
                        c.querySelector('.data-content').style.display = 'none';
                        c.querySelector('.skeleton').style.display = 'block';
                    });
                    document.querySelectorAll('#prayer-times-container .prayer-time').forEach(el => el.remove());
                    prayerSkeletons.forEach(s => s.style.display = 'flex');
                } else {
                    containers.forEach(c => {
                        c.querySelector('.data-content').style.display = 'block';
                        c.querySelector('.skeleton').style.display = 'none';
                    });
                     prayerSkeletons.forEach(s => s.style.display = 'none');
                }
            }

            // --- FUNGSI UTAMA PENGAMBIL DATA ---
            async function fetchAllData() {
                setSkeletonLoading(true);
                await fetchWeatherData();
                await fetchPrayerTimes();
                setSkeletonLoading(false);
                updateNextPrayerHighlight();
            }

            // --- FUNGSI AMBIL DATA CUACA ---
            async function fetchWeatherData() {
                const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${currentLatitude}&longitude=${currentLongitude}&current=temperature_2m,relative_humidity_2m,weather_code,surface_pressure`;
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    const current = data.current;
                    const statusText = `Diperbarui ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;

                    document.getElementById('temperature-value').textContent = `${current.temperature_2m.toFixed(1)} Â°C`;
                    document.getElementById('humidity-value').textContent = `${current.relative_humidity_2m} %`;
                    document.getElementById('pressure-value').innerHTML = `${current.surface_pressure.toFixed(0)} <span class="text-xl">hPa</span>`;
                    const weatherInfo = getWeatherInfo(current.weather_code);
                    document.getElementById('weather-value').textContent = weatherInfo.desc;
                    document.getElementById('weather-icon-container').innerHTML = weatherInfo.icon;
                    
                    document.querySelectorAll('#temperature-status, #humidity-status, #weather-status, #pressure-status').forEach(el => el.textContent = statusText);
                } catch (error) {
                    console.error('Gagal mengambil data cuaca:', error);
                    document.querySelectorAll('#temperature-status, #humidity-status, #weather-status, #pressure-status').forEach(el => el.textContent = 'Gagal memuat.');
                }
            }
            
            // --- FUNGSI AMBIL DATA WAKTU SHOLAT ---
            async function fetchPrayerTimes() {
                 const apiUrl = `https://api.aladhan.com/v1/timings?latitude=${currentLatitude}&longitude=${currentLongitude}&method=10`;
                try {
                    const response = await fetch(apiUrl);
                     if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    if(data.code !== 200) throw new Error('API Waktu Sholat error');
                    
                    const timings = data.data.timings;
                    const prayerData = {
                        Fajr: { name: 'Subuh', icon: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m-6.364-8.364l-.707.707M19.071 5.929l-.707.707M3 12h1m16 0h-1M6.343 17.657l.707.707M17.657 6.343l.707.707" /></svg>`},
                        Dhuhr: { name: 'Dzuhur', icon: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`},
                        Asr: { name: 'Ashar', icon: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`},
                        Maghrib: { name: 'Maghrib', icon: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`},
                        Isha: { name: 'Isya', icon: `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`},
                    };
                    
                    prayerContainer.innerHTML = '';
                    Object.keys(prayerData).forEach(key => {
                        prayerContainer.innerHTML += `
                            <div id="prayer-${key.toLowerCase()}" class="prayer-time card bg-white dark:bg-slate-800 p-4 rounded-lg shadow flex flex-col items-center justify-center transition-all duration-300 border border-transparent dark:border-slate-700">
                                <div class="flex items-center gap-2 mb-1 text-slate-600 dark:text-slate-300">${prayerData[key].icon} <h3 class="text-md font-semibold">${prayerData[key].name}</h3></div>
                                <p class="text-2xl font-bold text-slate-800 dark:text-white">${timings[key]}</p>
                            </div>`;
                    });
                } catch (error) {
                    console.error('Gagal mengambil data waktu sholat:', error);
                    prayerContainer.innerHTML = '<p class="col-span-full text-center text-slate-500 dark:text-slate-400">Gagal memuat jadwal sholat.</p>';
                }
            }
            
            function updateNextPrayerHighlight() {
                const currentTime = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                let nextPrayerName = null;
                
                document.querySelectorAll('.prayer-time').forEach(el => el.classList.remove('next'));
                const prayerOrder = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
                
                for (const prayer of prayerOrder) {
                    const el = document.getElementById(`prayer-${prayer.toLowerCase()}`);
                    if (el && el.querySelector('p').textContent > currentTime) {
                        nextPrayerName = prayer; break;
                    }
                }
                
                if (!nextPrayerName) nextPrayerName = 'Fajr';
                const nextPrayerEl = document.getElementById(`prayer-${nextPrayerName.toLowerCase()}`);
                if(nextPrayerEl) nextPrayerEl.classList.add('next');
            }

            // --- LOGIKA TO-DO LIST ---
            function renderTodos() {
                todoListEl.innerHTML = '';
                if(todos.length === 0) {
                    todoListEl.innerHTML = '<li class="text-center text-slate-500">Belum ada tugas.</li>';
                }
                todos.forEach((todo, index) => {
                    const li = document.createElement('li');
                    li.className = `task-item flex items-center justify-between p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 ${todo.completed ? 'completed' : ''}`;
                    li.dataset.index = index;
                    li.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" class="task-checkbox h-5 w-5 rounded text-indigo-600 focus:ring-indigo-500 border-slate-300" ${todo.completed ? 'checked' : ''}>
                            <span>${todo.text}</span>
                        </div>
                        <button class="delete-task-btn text-slate-400 hover:text-red-500">&times;</button>`;
                    todoListEl.appendChild(li);
                });
            }

            function saveTodos() {
                localStorage.setItem('todos', JSON.stringify(todos));
            }

            function loadTodos() {
                const savedTodos = localStorage.getItem('todos');
                if(savedTodos) {
                    todos = JSON.parse(savedTodos);
                }
                renderTodos();
            }

            todoForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = todoInput.value.trim();
                if(text) {
                    todos.push({ text, completed: false });
                    todoInput.value = '';
                    saveTodos();
                    renderTodos();
                }
            });

            todoListEl.addEventListener('click', (e) => {
                const target = e.target;
                const li = target.closest('.task-item');
                if (!li) return;
                const index = parseInt(li.dataset.index);

                if(target.matches('.task-checkbox')) {
                    todos[index].completed = target.checked;
                } else if(target.matches('.delete-task-btn')) {
                    todos.splice(index, 1);
                } else {
                    // Clicking the item text also toggles completion
                    todos[index].completed = !todos[index].completed;
                }
                saveTodos();
                renderTodos();
            });


            // --- LOGIKA LOKASI & MODAL ---
            const modal = document.getElementById('location-modal');
            const changeLocationBtn = document.getElementById('change-location-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const locationForm = document.getElementById('location-form');
            const citySelect = document.getElementById('city-select');

            function populateCityDropdown() {
                cities.forEach(city => {
                    const option = document.createElement('option');
                    option.value = city.name;
                    option.textContent = city.name;
                    citySelect.appendChild(option);
                });
            }

            function initLocation() {
                const savedLocationName = localStorage.getItem('locationName') || "Bandung, Indonesia";
                const savedCity = cities.find(c => c.name === savedLocationName) || cities[0];

                currentLatitude = savedCity.lat;
                currentLongitude = savedCity.lon;
                
                locationDisplay.textContent = `Lokasi: ${savedCity.name}`;
                citySelect.value = savedCity.name;
                fetchAllData();
            }

            changeLocationBtn.addEventListener('click', () => modal.classList.remove('opacity-0', 'pointer-events-none'));
            closeModalBtn.addEventListener('click', () => modal.classList.add('opacity-0', 'pointer-events-none'));
            locationForm.addEventListener('submit', (e) => {
                e.preventDefault();
                localStorage.setItem('locationName', citySelect.value);
                closeModalBtn.click();
                initLocation();
            });

            // --- LOGIKA AI CHAT ---
            const chatModal = document.getElementById('ai-chat-modal');
            const aiChatFab = document.getElementById('ai-chat-fab');
            const closeChatBtn = document.getElementById('close-chat-btn');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatMessages = document.getElementById('chat-messages');

            aiChatFab.addEventListener('click', () => {
                chatModal.classList.remove('opacity-0', 'pointer-events-none');
                document.querySelector('#ai-chat-modal .modal-content').classList.remove('translate-y-full', 'sm:translate-y-10');
            });
            closeChatBtn.addEventListener('click', () => {
                 chatModal.classList.add('opacity-0', 'pointer-events-none');
                 document.querySelector('#ai-chat-modal .modal-content').classList.add('translate-y-full', 'sm:translate-y-10');
            });
            
            function addChatMessage(message, sender) {
                const messageEl = document.createElement('div');
                const bubble = document.createElement('div');
                bubble.innerHTML = message;
                
                if (sender === 'user') {
                    messageEl.className = 'flex justify-end';
                    bubble.className = 'bg-indigo-600 text-white rounded-lg p-3 max-w-lg';
                } else {
                    messageEl.className = 'flex justify-start';
                    bubble.className = 'bg-slate-200 dark:bg-slate-700 rounded-lg p-3 max-w-lg';
                }
                
                messageEl.appendChild(bubble);
                chatMessages.appendChild(messageEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const prompt = chatInput.value.trim();
                if (!prompt) return;

                addChatMessage(prompt, 'user');
                chatInput.value = '';
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const loadingEl = document.createElement('div');
                loadingEl.className = 'flex justify-start';
                loadingEl.innerHTML = `<div class="bg-slate-200 dark:bg-slate-700 rounded-lg p-3 max-w-lg animate-pulse-slow">...</div>`;
                chatMessages.appendChild(loadingEl);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                try {
                    const payload = { contents: chatHistory };
                    const apiKey = "AIzaSyA8SKk2FxIf3lQdsJIHWUhR1ZK8s2Yh2ZI";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (chatMessages.contains(loadingEl)) {
                        chatMessages.removeChild(loadingEl);
                    }

                    if (!response.ok) {
                        const errorMessage = result?.error?.message || "Terjadi kesalahan saat menghubungi server AI.";
                        throw new Error(errorMessage);
                    }
                    
                    if (result.candidates && result.candidates[0].content?.parts?.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        addChatMessage(text, 'ai');
                        chatHistory.push({ role: "model", parts: [{ text: text }] });
                    } else {
                        addChatMessage("Maaf, saya tidak dapat memberikan jawaban untuk permintaan ini karena alasan keamanan atau konten yang tidak valid.", 'ai');
                        console.warn("Gemini API response blocked or empty:", result);
                    }
                } catch (error) {
                    console.error("Gemini API error:", error);
                    if (chatMessages.contains(loadingEl)) {
                       chatMessages.removeChild(loadingEl);
                    }
                    addChatMessage(`Terjadi kesalahan: ${error.message}`, 'ai');
                }
            });

            // --- INISIALISASI ---
            document.querySelectorAll('.clickable').forEach(el => {
                el.addEventListener('click', playClickSound);
            });
            populateCityDropdown();
            loadTodos();
            initLocation();
            setInterval(fetchAllData, 600000);
            setInterval(updateNextPrayerHighlight, 60000);

            // --- FUNGSI BANTUAN & THEME TOGGLE (TIDAK BERUBAH) ---
            function getWeatherInfo(code) { 
                 const weatherMap={0:{desc:"Cerah",icon:`<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.592a.75.75 0 01-1.06-1.061l1.591-1.591a.75.75 0 011.06 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5h2.25a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 01-1.06 0l-1.591-1.592a.75.75 0 111.06-1.06l1.591 1.591a.75.75 0 010 1.061zM12 18a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.166 17.834a.75.75 0 010-1.06l1.591-1.591a.75.75 0 111.06 1.06l-1.591 1.59a.75.75 0 01-1.06 0zM5.106 7.166a.75.75 0 011.06 0l1.591 1.591a.75.75 0 01-1.06 1.06l-1.591-1.59a.75.75 0 010-1.061zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12z"/></svg>`},1:{desc:"Cerah Berawan",icon:`<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z" clip-rule="evenodd" /><path d="M12.25,1.071c-4.88,0.49-8.75,4.36-9.24,9.24C2.52,15.191,3.48,19,7.5,19c4.02,0,7.48-3.35,7.97-7.75 C16.52,6.37,15.75,2.14,12.25,1.071z M12,17c-2.76,0-5-2.24-5-5s2.24-5,5-5s5,2.24,5,5S14.76,17,12,17z"/></svg>`},2:{desc:"Berawan",icon:`<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M4.5 9.75a6 6 0 0111.57-2.015.75.75 0 00.358-.815A7.5 7.5 0 106.84 15.63a.75.75 0 00.913-.642 6 6 0 01-3.253-5.238z" clip-rule="evenodd" /><path d="M15.75 12a3.75 3.75 0 100 7.5 3.75 3.75 0 000-7.5zM14.25 15a.75.75 0 001.5 0v-1.5a.75.75 0 00-1.5 0v1.5z" /></svg>`},3:{desc:"Mendung",icon:`<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" viewBox="0 0 24 24" fill="currentColor"><path d="M18 12.375c0 .252.012.499.035.744a8.251 8.251 0 01-2.923 5.795.75.75 0 01-1.066-1.056 6.751 6.751 0 002.454-4.743A6.732 6.732 0 0015.75 12c0-3.47-2.64-6.32-6-6.682a.75.75 0 01.732-1.482 8.25 8.25 0 018.268 8.25z" /><path d="M10.5 3.375A6.75 6.75 0 003.75 10.125c0 3.727 3.023 6.75 6.75 6.75 3.47 0 6.32-2.64 6.682-6a.75.75 0 00-1.482-.232A5.25 5.25 0 0110.5 15.375a5.25 5.25 0 01-5.25-5.25c0-2.658 1.96-4.862 4.5-5.197a.75.75 0 00.75-1.495z" /></svg>`},61:{desc:"Hujan Ringan",icon:`<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" viewBox="0 0 24 24" fill="currentColor"><path d="M10.5 4.5a6.75 6.75 0 00-5.763 9.444L3.46 16.22a.75.75 0 101.08 1.04l1.272-1.316A6.75 6.75 0 0010.5 18a6.75 6.75 0 006.75-6.75c0-3.515-2.655-6.425-6-6.732z" /><path d="M9 19.5a.75.75 0 001.5 0v-2.25a.75.75 0 00-1.5 0v2.25zM12.75 19.5a.75.75 0 001.5 0v-2.25a.75.75 0 00-1.5 0v2.25z"/></svg>`},95:{desc:"Badai Petir",icon:`<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.5 3.75a.75.75 0 01.75.75v4.5a.75.75 0 01-1.5 0V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M5.528 8.028a.75.75 0 01.972-.472l3.75 1.5a.75.75 0 010 1.388l-3.75 1.5a.75.75 0 01-.972-.916l.5-1.25a.75.75 0 010-.472l-.5-1.25a.75.75 0 010-.472z" clip-rule="evenodd" /><path d="M12.991 19.529a.75.75 0 01-1.482.232A5.25 5.25 0 0110.5 15.375a5.25 5.25 0 01-5.25-5.25c0-2.658 1.96-4.862 4.5-5.197a.75.75 0 01.732 1.482 3.75 3.75 0 00-3.214 3.715 3.75 3.75 0 003.75 3.75 3.75 3.75 0 003.491-2.417.75.75 0 111.417.484c-.45 1.32-1.606 2.378-3.009 2.655a.75.75 0 01-.657-.595z" /></svg>`},};
                return weatherMap[code] || { desc: "Tidak Diketahui", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-full w-full" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>` };
            }
            const themeToggle = document.getElementById('theme-toggle');
            const htmlEl = document.documentElement;
            const applyTheme = (theme) => {
                const sunIcon = document.getElementById('theme-icon-sun');
                const moonIcon = document.getElementById('theme-icon-moon');
                if (theme === 'dark') {
                    htmlEl.classList.add('dark'); sunIcon.classList.remove('hidden'); moonIcon.classList.add('hidden');
                } else {
                    htmlEl.classList.remove('dark'); sunIcon.classList.add('hidden'); moonIcon.classList.remove('hidden');
                }
            };
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
            themeToggle.addEventListener('click', () => {
                const newTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
        });
    </script>
</body>
</html>
